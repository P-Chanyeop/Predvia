using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using System;
using System.IO;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading.Tasks;
using System.Diagnostics;
using System.Collections.Generic;
using Gumaedaehang.Services;

namespace Gumaedaehang.Services
{
    public class ThumbnailWebServer
    {
        private WebApplication? _app;
        private readonly ThumbnailService _thumbnailService;
        private bool _isRunning = false;

        public ThumbnailWebServer()
        {
            _thumbnailService = new ThumbnailService();
        }

        public async Task StartAsync()
        {
            if (_isRunning) return;

            try
            {
                var builder = WebApplication.CreateBuilder();
                
                // CORS ì„œë¹„ìŠ¤ ì¶”ê°€
                builder.Services.AddCors();
                
                _app = builder.Build();
                
                // CORS ì •ì±… ì„¤ì •
                _app.UseCors(policy => policy
                    .AllowAnyOrigin()
                    .AllowAnyMethod()
                    .AllowAnyHeader());

                // API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
                _app.MapPost("/api/thumbnails/save", HandleSaveThumbnails);
                _app.MapGet("/api/thumbnails/list", HandleGetThumbnails);

                _isRunning = true;
                
                // ë¡œê·¸ëŠ” MainWindowì—ì„œ ì²˜ë¦¬

                // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ ì‹¤í–‰
                _ = Task.Run(async () =>
                {
                    try
                    {
                        await _app.RunAsync("http://localhost:8080");
                    }
                    catch (Exception ex)
                    {
                        LogWindow.AddLogStatic($"âŒ ì›¹ì„œë²„ ì‹¤í–‰ ì˜¤ë¥˜: {ex.Message}");
                    }
                });

                // ì„œë²„ ì‹œì‘ ëŒ€ê¸°
                await Task.Delay(1000);
            }
            catch (Exception ex)
            {
                LogWindow.AddLogStatic($"âŒ ì›¹ì„œë²„ ì‹œì‘ ì˜¤ë¥˜: {ex.Message}");
                Debug.WriteLine($"ì›¹ì„œë²„ ì‹œì‘ ì˜¤ë¥˜: {ex.Message}");
            }
        }

        // ì¸ë„¤ì¼ ì €ì¥ API
        private async Task<IResult> HandleSaveThumbnails(HttpContext context)
        {
            try
            {
                LogWindow.AddLogStatic("ğŸ“¡ API ìš”ì²­ ìˆ˜ì‹ : POST /api/thumbnails/save");

                using var reader = new StreamReader(context.Request.Body);
                var json = await reader.ReadToEndAsync();
                
                LogWindow.AddLogStatic($"ìˆ˜ì‹ ëœ ë°ì´í„° í¬ê¸°: {json.Length} bytes");
                LogWindow.AddLogStatic($"JSON ë‚´ìš©: {json.Substring(0, Math.Min(500, json.Length))}");

                ThumbnailSaveRequest? requestData = null;
                try
                {
                    requestData = JsonSerializer.Deserialize<ThumbnailSaveRequest>(json);
                }
                catch (Exception jsonEx)
                {
                    LogWindow.AddLogStatic($"JSON ì—­ì§ë ¬í™” ì˜¤ë¥˜: {jsonEx.Message}");
                    return Results.BadRequest($"JSON parsing error: {jsonEx.Message}");
                }
                
                if (requestData?.Products == null)
                {
                    LogWindow.AddLogStatic("ì˜ëª»ëœ ìš”ì²­ ë°ì´í„°");
                    return Results.BadRequest("Invalid request data");
                }

                LogWindow.AddLogStatic($"{requestData.Products.Count}ê°œ ì¸ë„¤ì¼ ì €ì¥ ì‹œì‘...");

                int savedCount = 0;
                foreach (var product in requestData.Products)
                {
                    try
                    {
                        await _thumbnailService.SaveThumbnailAsync(
                            product.Id,
                            product.Title,
                            product.ThumbnailUrl,
                            product.Price,
                            product.Link
                        );
                        savedCount++;
                    }
                    catch (Exception ex)
                    {
                        LogWindow.AddLogStatic($"âŒ ì¸ë„¤ì¼ ì €ì¥ ì‹¤íŒ¨: {product.Title} - {ex.Message}");
                    }
                }

                LogWindow.AddLogStatic($"{savedCount}ê°œ ì¸ë„¤ì¼ ì €ì¥ ì™„ë£Œ");

                var response = new { 
                    success = true,
                    savedCount = savedCount, 
                    totalCount = requestData.Products.Count,
                    message = $"{savedCount}ê°œ ì¸ë„¤ì¼ ì €ì¥ ì™„ë£Œ"
                };
                
                return Results.Json(response, new JsonSerializerOptions 
                { 
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase 
                });
            }
            catch (Exception ex)
            {
                LogWindow.AddLogStatic($"API ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
                return Results.Json(new { 
                    success = false, 
                    error = ex.Message 
                }, statusCode: 500);
            }
        }

        // ì¸ë„¤ì¼ ëª©ë¡ ì¡°íšŒ API
        private async Task<IResult> HandleGetThumbnails(HttpContext context)
        {
            try
            {
                LogWindow.AddLogStatic("ğŸ“¡ API ìš”ì²­ ìˆ˜ì‹ : GET /api/thumbnails/list");
                
                var thumbnails = await _thumbnailService.GetThumbnailsAsync();
                return Results.Ok(thumbnails);
            }
            catch (Exception ex)
            {
                LogWindow.AddLogStatic($"âŒ API ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
                return Results.StatusCode(500);
            }
        }

        public async Task StopAsync()
        {
            if (_app != null && _isRunning)
            {
                await _app.StopAsync();
                _isRunning = false;
                LogWindow.AddLogStatic("ì›¹ì„œë²„ ì¤‘ì§€ë¨");
            }
        }
    }
}
